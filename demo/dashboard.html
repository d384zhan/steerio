<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steerio Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f5f5f4;
  --surface: #ffffff;
  --text: #1c1917;
  --text-secondary: #57534e;
  --text-muted: #a8a29e;
  --border: #e7e5e4;
  --border-strong: #d6d3d1;
  --blue: #2563eb;
  --blue-light: #eff6ff;
  --blue-mid: #dbeafe;
  --amber: #d97706;
  --amber-light: #fffbeb;
  --amber-bg: #fef3c7;
  --red: #dc2626;
  --red-light: #fef2f2;
  --orange: #ea580c;
  --orange-light: #fff7ed;
  --green: #16a34a;
  --green-light: #f0fdf4;
  --green-mid: #dcfce7;
  --slate: #64748b;
  --purple: #7c3aed;
  --purple-light: #f5f3ff;
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --shadow-xs: 0 1px 2px rgba(28,25,23,0.04);
  --shadow-sm: 0 1px 3px rgba(28,25,23,0.06), 0 1px 2px rgba(28,25,23,0.04);
  --shadow: 0 4px 6px -1px rgba(28,25,23,0.07), 0 2px 4px -2px rgba(28,25,23,0.05);
  --shadow-md: 0 8px 16px -4px rgba(28,25,23,0.08), 0 4px 6px -2px rgba(28,25,23,0.04);
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
}

html, body {
  height: 100%;
  font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  font-size: 14px;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  letter-spacing: -0.01em;
}

/* Layout */
.app {
  display: grid;
  grid-template-rows: 52px 1fr;
  height: 100vh;
  width: 100vw;
}

.main {
  display: grid;
  grid-template-columns: 280px 1px 1fr;
  overflow: hidden;
}

/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  padding: 0 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 16px;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  font-weight: 700;
  font-size: 17px;
  color: var(--text);
  letter-spacing: -0.5px;
}

.logo span {
  color: var(--blue);
}

.conn-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 500;
  background: var(--bg);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.conn-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-muted);
}

.conn-pill.connected .conn-dot { background: var(--green); }
.conn-pill.connected { color: var(--green); border-color: var(--green); background: var(--green-light); }
.conn-pill.disconnected .conn-dot { background: var(--red); }
.conn-pill.disconnected { color: var(--red); border-color: var(--red); background: var(--red-light); }

.topbar-center {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.call-info {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.call-info:empty::after {
  content: "No active call";
  color: var(--text-muted);
  font-weight: 400;
}

.state-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
  background: var(--bg);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

.state-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-muted);
}

.state-badge[data-state="listening"] .state-dot { background: var(--green); animation: pulse 2s infinite; }
.state-badge[data-state="thinking"] .state-dot { background: var(--amber); animation: blink 0.5s step-start infinite; }
.state-badge[data-state="speaking"] .state-dot { background: var(--blue); animation: pulse 1s infinite; }
.state-badge[data-state="waiting"] .state-dot { background: var(--amber); animation: pulse 1.2s infinite; }

.judge-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
  background: var(--bg);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.judge-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-muted);
}

.judge-badge[data-judge="evaluating"] .judge-dot { background: var(--amber); animation: blink 0.4s step-start infinite; }
.judge-badge[data-judge="evaluating"] { color: var(--amber); border-color: var(--amber); background: var(--amber-light); }
.judge-badge[data-judge="rule_caught"] .judge-dot { background: var(--red); }
.judge-badge[data-judge="rule_caught"] { color: var(--red); border-color: var(--red); background: var(--red-light); }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Segmented mode control */
.mode-toggle {
  display: flex;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
  background: var(--bg);
}

.mode-btn {
  padding: 5px 14px;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
}

.mode-btn + .mode-btn { border-left: 1px solid var(--border); }

.mode-btn:hover { background: var(--border); }
.mode-btn.active-llm { background: var(--blue); color: white; }
.mode-btn.active-human { background: var(--amber); color: white; }

@keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
@keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }
@keyframes pulse-amber { 0%, 100% { box-shadow: 0 0 0 0 rgba(217,119,6,0.4); } 50% { box-shadow: 0 0 0 4px rgba(217,119,6,0); } }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-8px); }
  to { opacity: 1; transform: translateX(0); }
}

/* Left Panel: Calls */
.panel-calls {
  background: var(--surface);
  border-right: none;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px 10px;
  flex-shrink: 0;
}

.panel-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.call-count {
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 500;
  margin-left: 6px;
}

/* Dial panel */
.dial-panel {
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.dial-panel input[type="tel"] {
  height: 36px;
  padding: 0 12px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  outline: none;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.dial-panel input[type="tel"]:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.12); }

.dial-panel select {
  height: 36px;
  padding: 0 10px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  outline: none;
  cursor: pointer;
}

.btn-dial {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  height: 36px;
  padding: 0 16px;
  background: var(--blue);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  box-shadow: var(--shadow-xs);
}

.btn-dial:hover { background: #1d4ed8; box-shadow: var(--shadow-sm); }
.btn-dial:active { transform: scale(0.97); }
.btn-dial:disabled { opacity: 0.5; cursor: default; transform: none; }

.btn-hangup {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 5px 14px;
  background: var(--red);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  box-shadow: var(--shadow-xs);
}

.btn-hangup:hover { background: #b91c1c; }
.btn-hangup:active { transform: scale(0.97); }
.btn-hangup.visible { display: flex; }

/* Call list */
.calls-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 8px 8px;
}

.calls-list::-webkit-scrollbar { width: 3px; }
.calls-list::-webkit-scrollbar-track { background: transparent; }
.calls-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.calls-empty {
  padding: 32px 16px;
  text-align: center;
  color: var(--text-muted);
  font-size: 13px;
}

.call-card {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  cursor: pointer;
  margin-bottom: 2px;
  transition: all 0.1s;
}

.call-card:hover { background: var(--bg); }
.call-card.selected { background: var(--blue-light); }
.call-card.ended { opacity: 0.5; }

.call-dot-wrap {
  padding-top: 4px;
  flex-shrink: 0;
}

.call-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
}

.call-card.ended .call-dot { background: var(--text-muted); }
.call-card.waiting .call-dot { background: var(--amber); animation: pulse 1.2s infinite; }

.call-body {
  flex: 1;
  min-width: 0;
}

.call-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.call-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 2px;
}

.call-mode-badge {
  font-size: 10px;
  font-weight: 600;
  padding: 1px 6px;
  border-radius: 100px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.call-mode-badge.llm { background: var(--blue-light); color: var(--blue); }
.call-mode-badge.human { background: var(--amber-light); color: var(--amber); }

.call-snippet {
  font-size: 12px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 3px;
}

.call-risk {
  flex-shrink: 0;
  padding-top: 2px;
}

.call-risk-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.call-risk-dot.medium { background: var(--amber); }
.call-risk-dot.high { background: var(--orange); }
.call-risk-dot.critical { background: var(--red); }

/* Panel divider */
.panel-divider {
  background: var(--border);
}

/* Right Panel: Detail */
.panel-detail {
  background: var(--bg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

.detail-toolbar {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 0;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.filter-tab {
  padding: 10px 18px;
  border: none;
  background: transparent;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}

.filter-tab:hover { color: var(--text-secondary); }
.filter-tab.active { color: var(--text); border-bottom-color: var(--blue); font-weight: 600; }
.filter-tab.active-flagged { color: var(--red); border-bottom-color: var(--red); font-weight: 600; }

.toolbar-spacer { flex: 1; }

.btn-verdict-history {
  padding: 5px 12px;
  margin-right: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.btn-verdict-history:hover { background: var(--bg); border-color: var(--border-strong); }
.btn-verdict-history.active { background: var(--blue-light); color: var(--blue); border-color: var(--blue); }

/* ═══════════════════════════════════════════════
   TRANSCRIPT — centered chat area
   ═══════════════════════════════════════════════ */
.transcript {
  flex: 1;
  overflow-y: auto;
  padding: 24px 24px;
  display: flex;
  flex-direction: column;
  gap: 3px;
  align-items: center;
}

.transcript::-webkit-scrollbar { width: 4px; }
.transcript::-webkit-scrollbar-track { background: transparent; }
.transcript::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }

.transcript-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-size: 14px;
}

/* Centered container for all transcript items */
.transcript > * {
  width: 100%;
  max-width: 680px;
}

/* ═══════════════════════════════════════════════
   CHAT BUBBLES — polished conversation messages
   ═══════════════════════════════════════════════ */
.msg {
  padding: 10px 16px;
  border-radius: var(--radius-xl);
  font-size: 14px;
  line-height: 1.6;
  word-break: break-word;
  animation: fadeUp 0.2s ease;
  position: relative;
}

.msg.user {
  align-self: flex-start;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl) var(--radius-xl) var(--radius-xl) 6px;
  box-shadow: var(--shadow-xs);
  max-width: 85%;
}

.msg.agent {
  align-self: flex-end;
  background: var(--blue);
  color: white;
  border-radius: var(--radius-xl) var(--radius-xl) 6px var(--radius-xl);
  box-shadow: var(--shadow-sm);
  max-width: 85%;
}

.msg.agent .msg-speaker { color: rgba(255,255,255,0.7); }
.msg.agent .msg-time { color: rgba(255,255,255,0.5); }

/* Risk-based agent bubble overrides */
.msg.agent.risk-low { background: var(--blue); }
.msg.agent.risk-medium { background: #b45309; }
.msg.agent.risk-high { background: #c2410c; }
.msg.agent.risk-critical { background: var(--red); }
.msg.agent.blocked { background: var(--red); opacity: 0.6; }
.msg.agent.blocked .msg-text { text-decoration: line-through; }

/* ═══════════════════════════════════════════════
   SYSTEM EVENTS — banners, not bubbles
   Inject, Override, Operator Speak, Tool Calls
   ═══════════════════════════════════════════════ */
.msg.system {
  align-self: center;
  background: transparent;
  color: var(--text-muted);
  font-size: 12px;
  text-align: center;
  padding: 4px 12px;
  max-width: 100%;
  border-radius: 0;
}

.sys-event {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 14px;
  border-radius: var(--radius);
  font-family: var(--mono);
  font-size: 12.5px;
  line-height: 1.5;
  animation: slideIn 0.2s ease;
  max-width: 100%;
  border: 1px solid;
}

.sys-event .sys-icon {
  flex-shrink: 0;
  width: 18px;
  height: 18px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  color: white;
  margin-top: 1px;
}

.sys-event .sys-label {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin-bottom: 2px;
}

.sys-event .sys-body {
  flex: 1;
  min-width: 0;
}

.sys-event .sys-text {
  word-break: break-word;
}

/* Inject */
.sys-event.inject {
  background: #f0f7ff;
  border-color: var(--blue-mid);
}
.sys-event.inject .sys-icon { background: var(--blue); }
.sys-event.inject .sys-label { color: var(--blue); }
.sys-event.inject .sys-text { color: #1e40af; }

/* Override */
.sys-event.override {
  background: #fef2f2;
  border-color: #fecaca;
}
.sys-event.override .sys-icon { background: var(--red); }
.sys-event.override .sys-label { color: var(--red); }
.sys-event.override .sys-text { color: #991b1b; }

/* Operator speak */
.sys-event.operator {
  background: #f0fdf4;
  border-color: var(--green-mid);
}
.sys-event.operator .sys-icon { background: var(--green); }
.sys-event.operator .sys-label { color: var(--green); }
.sys-event.operator .sys-text { color: #166534; }

/* Tool call */
.sys-event.toolcall {
  background: var(--purple-light);
  border-color: #e9d5ff;
}
.sys-event.toolcall .sys-icon { background: var(--purple); }
.sys-event.toolcall .sys-label { color: var(--purple); }
.sys-event.toolcall .sys-text { color: #5b21b6; }

/* ═══════════════════════════════════════════════ */

.msg-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 2px;
}

.msg-speaker {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
}

.msg-time {
  font-size: 10px;
  color: var(--text-muted);
}

/* Inline verdict badge */
.verdict-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 6px;
  padding: 2px 8px;
  border-radius: 100px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}

.verdict-badge.risk-low { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.8); }
.verdict-badge.risk-medium { background: rgba(255,255,255,0.2); color: rgba(255,255,255,0.9); }
.verdict-badge.risk-high { background: rgba(255,255,255,0.25); color: white; }
.verdict-badge.risk-critical { background: rgba(255,255,255,0.25); color: white; }

.verdict-badge:hover { background: rgba(255,255,255,0.35); }

.verdict-detail {
  display: none;
  margin-top: 8px;
  padding: 8px 12px;
  background: rgba(255,255,255,0.15);
  border-radius: var(--radius-sm);
  font-size: 12px;
  font-family: var(--mono);
  color: rgba(255,255,255,0.9);
  line-height: 1.5;
}

.verdict-detail.open { display: block; }

.verdict-reasoning { margin-bottom: 4px; }

.corrective {
  display: block;
  margin-top: 8px;
  padding: 8px 12px;
  background: rgba(255,255,255,0.15);
  border-radius: var(--radius-sm);
  color: rgba(255,255,255,0.9);
  font-size: 13px;
}

/* Guidance card */
.guidance-card {
  max-width: 100%;
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--amber);
  background: var(--amber-light);
  border-radius: var(--radius-lg);
  animation: fadeUp 0.2s ease;
}

.guidance-card.resolved {
  border-color: var(--border);
  background: var(--bg);
  opacity: 0.6;
}

.guidance-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.guidance-pulse {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--amber);
  animation: pulse-amber 1.5s infinite;
}

.guidance-card.resolved .guidance-pulse { display: none; }

.guidance-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: #92400e;
}

.guidance-card.resolved .guidance-label { color: var(--green); }

.guidance-question {
  font-size: 14px;
  color: var(--text);
  margin-bottom: 10px;
  line-height: 1.5;
}

.guidance-mic-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.guidance-mic {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--amber);
  background: var(--surface);
  color: var(--amber);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
}

.guidance-mic:hover { background: var(--amber-light); }

.guidance-mic.recording {
  background: var(--red);
  border-color: var(--red);
  color: white;
  animation: pulse 1s infinite;
}

.guidance-mic.transcribing {
  background: var(--amber);
  border-color: var(--amber);
  color: white;
  opacity: 0.7;
  cursor: default;
}

.guidance-mic svg { width: 20px; height: 20px; fill: currentColor; }

.guidance-mic-label {
  font-size: 13px;
  color: var(--text-secondary);
}

.guidance-sent {
  font-size: 13px;
  color: var(--green);
  margin-top: 8px;
  font-weight: 500;
}

/* Verdict History Drawer */
.verdict-drawer {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  transform: translateY(100%);
  transition: transform 0.25s ease;
  max-height: 45%;
  display: flex;
  flex-direction: column;
  z-index: 10;
}

.verdict-drawer.open { transform: translateY(0); }

.drawer-handle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  cursor: pointer;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}

.drawer-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
}

.drawer-close {
  border: none;
  background: transparent;
  font-size: 18px;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0 4px;
}

.verdict-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px 20px 16px;
}

.verdict-list::-webkit-scrollbar { width: 3px; }
.verdict-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.vh-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.vh-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.vh-dot.none { background: var(--green); }
.vh-dot.low { background: var(--slate); }
.vh-dot.medium { background: var(--amber); }
.vh-dot.high { background: var(--orange); }
.vh-dot.critical { background: var(--red); }

.vh-action {
  font-weight: 500;
  color: var(--text-secondary);
}

.vh-reason {
  flex: 1;
  color: var(--text-muted);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 12px;
}

.vh-time {
  font-size: 11px;
  color: var(--text-muted);
  flex-shrink: 0;
}

/* ═══════════════════════════════════════════════
   INPUT BAR
   ═══════════════════════════════════════════════ */
.inputbar {
  display: flex;
  align-items: center;
  gap: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.inputbar input {
  flex: 1;
  height: 48px;
  padding: 0 16px;
  background: transparent;
  border: none;
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  outline: none;
}

.inputbar input::placeholder { color: var(--text-muted); }

.inputbar-buttons {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 0 10px;
}

.inputbar-btn {
  height: 32px;
  padding: 0 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: transparent;
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.12s;
}

.inputbar-btn:hover { background: var(--bg); border-color: var(--border-strong); }
.btn-inject:hover { background: var(--blue-light); color: var(--blue); border-color: var(--blue); }
.btn-speak:hover { background: var(--green-light); color: var(--green); border-color: var(--green); }

.btn-inject:active, .btn-inject.sent { background: var(--blue); color: #fff; border-color: var(--blue); }
.btn-speak:active, .btn-speak.sent { background: var(--green); color: #fff; border-color: var(--green); }

.inputbar-btn.sent { transition: all 0.05s; }

.inputbar.flash { animation: input-flash 0.35s ease; }
@keyframes input-flash {
  0% { background: var(--surface); }
  15% { background: var(--blue-light); }
  100% { background: var(--surface); }
}

.shortcut-hint {
  padding: 0 12px;
  font-size: 10px;
  color: var(--text-muted);
  white-space: nowrap;
  font-family: var(--mono);
  letter-spacing: 0;
}

/* Scroll pill */
.scroll-pill {
  position: absolute;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  color: var(--text-secondary);
  border: 1px solid var(--border);
  border-radius: 100px;
  padding: 6px 16px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s ease;
  box-shadow: var(--shadow);
}

.scroll-pill.visible { opacity: 1; pointer-events: auto; }
.scroll-pill:hover { background: var(--bg); }

/* Ack toast */
.ack-toast {
  position: fixed;
  top: 64px;
  right: 20px;
  padding: 10px 18px;
  border-radius: var(--radius);
  font-size: 12px;
  font-weight: 600;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-6px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  box-shadow: var(--shadow);
  font-family: var(--mono);
}

.ack-toast.visible { opacity: 1; transform: translateY(0); }
.ack-toast.ok { background: var(--green-light); color: var(--green); border: 1px solid var(--green-mid); }
.ack-toast.fail { background: var(--red-light); color: var(--red); border: 1px solid #fecaca; }
.ack-toast.ok-inject { background: var(--blue-light); color: var(--blue); border: 1px solid var(--blue-mid); }
.ack-toast.ok-speak { background: var(--green-light); color: var(--green); border: 1px solid var(--green-mid); }
</style>
</head>
<body>

<div class="app">

  <header class="topbar">
    <div class="topbar-left">
      <span class="logo">steer<span>io</span></span>
      <div class="conn-pill" id="connPill">
        <div class="conn-dot"></div>
        <span id="connLabel">Connecting</span>
      </div>
    </div>

    <div class="topbar-center">
      <span class="call-info" id="callInfo"></span>
      <div class="state-badge" id="stateBadge" data-state="">
        <div class="state-dot"></div>
        <span id="stateLabel">&mdash;</span>
      </div>
      <div class="judge-badge" id="judgeBadge" data-judge="idle">
        <div class="judge-dot"></div>
        <span id="judgeLabel">Judge idle</span>
      </div>
    </div>

    <div class="topbar-right">
      <div class="mode-toggle" id="modeToggle">
        <button class="mode-btn active-llm" data-mode="llm">LLM</button>
        <button class="mode-btn" data-mode="human">Human</button>
      </div>
      <button class="btn-hangup" id="btnHangUp">Hang Up</button>
    </div>
  </header>

  <main class="main">

    <aside class="panel-calls">
      <div class="panel-header">
        <div>
          <span class="panel-title">Calls</span>
          <span class="call-count" id="callCount"></span>
        </div>
      </div>
      <div class="dial-panel">
        <input type="tel" id="phoneInput" placeholder="+1 (555) 123-4567" />
        <select id="domainSelect">
          <option value="healthcare">Medical Triage</option>
          <option value="finance">Financial Advisory</option>
          <option value="ecommerce">E-Commerce Support</option>
        </select>
        <button class="btn-dial" id="btnDial">Dial</button>
      </div>
      <div class="calls-list" id="callsList">
        <div class="calls-empty" id="callsEmpty">No active calls</div>
      </div>
    </aside>

    <div class="panel-divider"></div>

    <section class="panel-detail">
      <div class="detail-toolbar">
        <button class="filter-tab active" id="filterAll">All</button>
        <button class="filter-tab" id="filterFlagged">Flagged</button>
        <div class="toolbar-spacer"></div>
        <button class="btn-verdict-history" id="btnVerdictHistory">Verdict History</button>
      </div>

      <div class="transcript" id="transcript">
        <div class="transcript-empty" id="transcriptEmpty">Select a call to view transcript</div>
      </div>

      <div class="scroll-pill" id="scrollPill">New messages</div>

      <div class="verdict-drawer" id="verdictDrawer">
        <div class="drawer-handle" id="drawerHandle">
          <span class="drawer-title">Verdict History</span>
          <button class="drawer-close">&times;</button>
        </div>
        <div class="verdict-list" id="verdictList"></div>
      </div>

      <div class="inputbar">
        <input type="text" id="cmdInput" placeholder="Operator instruction..." autocomplete="off" />
        <div class="inputbar-buttons">
          <button class="inputbar-btn btn-inject" id="btnInject">Inject</button>
          <button class="inputbar-btn btn-speak" id="btnSpeak">Speak</button>
        </div>
        <span class="shortcut-hint">enter inject &middot; shift+enter speak</span>
      </div>
    </section>

  </main>

</div>

<div class="ack-toast" id="ackToast"></div>

<script>
(function(){
  "use strict";

  // ── DOM refs ──
  var transcript = document.getElementById("transcript");
  var transcriptEmpty = document.getElementById("transcriptEmpty");
  var scrollPill = document.getElementById("scrollPill");
  var connPill = document.getElementById("connPill");
  var connLabel = document.getElementById("connLabel");
  var stateBadge = document.getElementById("stateBadge");
  var stateLabel = document.getElementById("stateLabel");
  var judgeBadge = document.getElementById("judgeBadge");
  var judgeLabel = document.getElementById("judgeLabel");
  var callInfo = document.getElementById("callInfo");
  var callsList = document.getElementById("callsList");
  var callsEmpty = document.getElementById("callsEmpty");
  var callCount = document.getElementById("callCount");
  var cmdInput = document.getElementById("cmdInput");
  var btnInject = document.getElementById("btnInject");
  var btnSpeak = document.getElementById("btnSpeak");
  var filterAll = document.getElementById("filterAll");
  var filterFlagged = document.getElementById("filterFlagged");
  var phoneInput = document.getElementById("phoneInput");
  var domainSelect = document.getElementById("domainSelect");
  var btnDial = document.getElementById("btnDial");
  var btnHangUp = document.getElementById("btnHangUp");
  var modeToggle = document.getElementById("modeToggle");
  var btnVerdictHistory = document.getElementById("btnVerdictHistory");
  var verdictDrawer = document.getElementById("verdictDrawer");
  var drawerHandle = document.getElementById("drawerHandle");
  var verdictList = document.getElementById("verdictList");
  var ackToast = document.getElementById("ackToast");

  // ── State ──
  var ws = null;
  var autoScroll = true;
  var selectedCallId = null;
  var filterMode = "all";
  var drawerOpen = false;
  var calls = new Map();

  function getCall(callId) {
    if (!calls.has(callId)) {
      calls.set(callId, {
        label: callId,
        status: "active",
        mode: "llm",
        agentState: "listening",
        transcripts: [],
        verdicts: [],
        guidanceRequests: new Map(),
        pendingVerdict: null,
        highestRisk: "none"
      });
    }
    return calls.get(callId);
  }

  // ── WebSocket ──
  function connect() {
    setConn("connecting");
    ws = new WebSocket("ws://localhost:8766/ws");
    ws.onopen = function(){ setConn("connected"); };
    ws.onclose = function(){ setConn("disconnected"); setTimeout(connect, 2000); };
    ws.onerror = function(){ setConn("disconnected"); };
    ws.onmessage = function(e){
      try { handleMessage(JSON.parse(e.data)); } catch(_){}
    };
  }

  function setConn(s) {
    connPill.className = "conn-pill " + s;
    var labels = { connecting: "Connecting", connected: "Connected", disconnected: "Disconnected" };
    connLabel.textContent = labels[s] || s;
  }

  function send(obj) {
    if (!ws || ws.readyState !== 1) return;
    obj.ts = Date.now() / 1000;
    if (selectedCallId && obj.payload) obj.payload.call_id = selectedCallId;
    ws.send(JSON.stringify(obj));
  }

  // ── Dispatch ──
  function handleMessage(msg) {
    var p = msg.payload || {};
    switch(msg.type) {
      case "call_started": onCallStarted(p); break;
      case "call_ended": onCallEnded(p); break;
      case "transcript": onTranscript(p, msg.ts); break;
      case "verdict": onVerdict(p, msg.ts); break;
      case "agent_state": onAgentState(p); break;
      case "guidance_request": onGuidanceRequest(p); break;
      case "judge_status": onJudgeStatus(p); break;
      case "context_update": onContextUpdate(p); break;
      case "call_status": onCallStatus(p); break;
      case "voice_transcription": onVoiceTranscription(p); break;
      case "ack": onAck(p); break;
    }
  }

  // ── Call lifecycle ──
  function onCallStarted(p) {
    var c = getCall(p.call_id);
    if (p.label) c.label = p.label;
    c.status = "active";
    if (!selectedCallId) selectCall(p.call_id);
    renderSidebar();
  }

  function onCallEnded(p) {
    var c = calls.get(p.call_id);
    if (c) { c.status = "ended"; renderSidebar(); }
  }

  // ── Transcript ──
  function onTranscript(p, ts) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.transcripts.push({ speaker: p.speaker, text: p.text, ts: ts, turnId: p.turn_id });
    if (cid === selectedCallId) renderTranscriptItem(p, ts, c);
    renderSidebar();
  }

  var RISK_ORDER = { none: 0, low: 1, medium: 2, high: 3, critical: 4 };

  // ── System event icons ──
  var SYS_ICONS = {
    inject: "I",
    override: "O",
    operator: "S",
    toolcall: "T"
  };

  function renderTranscriptItem(p, ts, call) {
    if (transcriptEmpty && transcriptEmpty.parentNode) transcriptEmpty.remove();

    var isAgent = p.speaker === "agent";
    var isSystem = p.speaker === "system";
    var isOperator = isSystem && p.text && p.text.indexOf("[OPERATOR]") === 0;
    var isInject = isSystem && p.text && p.text.indexOf("[INJECT]") === 0;
    var isOverride = isSystem && p.text && p.text.indexOf("[OVERRIDE]") === 0;
    var isToolCall = isSystem && p.text && p.text.indexOf("[TOOL]") === 0;
    var isSysEvent = isInject || isOverride || isOperator || isToolCall;
    var v = isAgent ? call.pendingVerdict : null;
    if (isAgent) call.pendingVerdict = null;

    var riskLevel = v ? v.risk_level : "none";
    var flagged = v && (riskLevel === "high" || riskLevel === "critical" || riskLevel === "medium");
    var blocked = v && v.action === "block";

    if (filterMode === "flagged" && !flagged && !isSysEvent) return;

    var el = document.createElement("div");

    // System events get a completely different component
    if (isSysEvent) {
      var evtType = isInject ? "inject" : isOverride ? "override" : isToolCall ? "toolcall" : "operator";
      var evtLabel = isInject ? "Inject" : isOverride ? "Override" : isToolCall ? "Tool Call" : "Operator";
      var displayText = p.text;
      if (isOperator) displayText = p.text.replace("[OPERATOR] ", "");
      else if (isInject) displayText = p.text.replace("[INJECT] ", "");
      else if (isOverride) displayText = p.text.replace("[OVERRIDE] ", "");
      else if (isToolCall) displayText = p.text.replace("[TOOL] ", "");

      el.className = "sys-event " + evtType;
      el.innerHTML = '<div class="sys-icon">' + SYS_ICONS[evtType] + '</div>'
        + '<div class="sys-body">'
        + '<div class="sys-label">' + esc(evtLabel) + ' <span style="font-weight:400;opacity:0.6;font-size:10px">' + fmtTime(ts) + '</span></div>'
        + '<div class="sys-text">' + esc(displayText) + '</div>'
        + '</div>';

      transcript.appendChild(el);
      if (autoScroll) scrollBottom();
      else scrollPill.classList.add("visible");
      return;
    }

    // Chat messages
    var cls = "msg";
    if (isSystem) cls += " system";
    else if (isAgent) cls += " agent";
    else cls += " user";

    if (v && riskLevel !== "none") cls += " risk-" + riskLevel;
    if (blocked) cls += " blocked";
    el.className = cls;

    var speakerLabel = isAgent ? "Agent" : p.speaker === "user" ? "Caller" : p.speaker;
    var html = '<div class="msg-meta">';
    html += '<span class="msg-speaker">' + esc(speakerLabel) + '</span>';
    html += '<span class="msg-time">' + fmtTime(ts) + '</span>';
    html += '</div>';
    html += '<span class="msg-text">' + esc(p.text) + '</span>';

    if (blocked && v.corrective_instruction) {
      html += '<span class="corrective">' + esc(v.corrective_instruction) + '</span>';
    }

    // Inline verdict badge for flagged agent messages
    if (v && riskLevel !== "none" && isAgent) {
      var vid = "v-" + Date.now() + "-" + Math.random().toString(36).slice(2,6);
      html += '<div class="verdict-badge risk-' + riskLevel + '" data-vid="' + vid + '">';
      html += esc(riskLevel) + ' &middot; ' + esc(v.action);
      html += '</div>';
      html += '<div class="verdict-detail" id="' + vid + '">';
      if (v.reasoning) html += '<div class="verdict-reasoning">' + esc(v.reasoning) + '</div>';
      if (v.corrective_instruction && !blocked) html += '<div style="margin-top:4px">' + esc(v.corrective_instruction) + '</div>';
      html += '</div>';
    }

    el.innerHTML = html;

    // Wire verdict badge click
    var badge = el.querySelector(".verdict-badge");
    if (badge) {
      badge.addEventListener("click", function() {
        var detail = document.getElementById(badge.getAttribute("data-vid"));
        if (detail) detail.classList.toggle("open");
      });
    }

    transcript.appendChild(el);

    if (autoScroll) scrollBottom();
    else scrollPill.classList.add("visible");
  }

  // ── Verdict ──
  function onVerdict(p, ts) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.pendingVerdict = p;
    c.verdicts.unshift({ v: p, ts: ts });

    if ((RISK_ORDER[p.risk_level] || 0) > (RISK_ORDER[c.highestRisk] || 0)) {
      c.highestRisk = p.risk_level;
    }

    if (cid === selectedCallId || !selectedCallId) {
      judgeBadge.setAttribute("data-judge", "idle");
      judgeLabel.textContent = "Judge idle";
    }
    if (c.verdicts.length > 50) c.verdicts.pop();
    if (cid === selectedCallId && drawerOpen) renderVerdictHistory(c);
    renderSidebar();
  }

  function renderVerdictHistory(call) {
    var html = "";
    for (var i = 0; i < call.verdicts.length; i++) {
      var item = call.verdicts[i];
      html += '<div class="vh-item">';
      html += '<span class="vh-dot ' + item.v.risk_level + '"></span>';
      html += '<span class="vh-action">' + esc(item.v.action) + '</span>';
      html += '<span class="vh-reason">' + esc(trunc(item.v.reasoning, 50)) + '</span>';
      html += '<span class="vh-time">' + fmtTime(item.ts) + '</span>';
      html += '</div>';
    }
    verdictList.innerHTML = html || '<div style="color:var(--text-muted);padding:16px 0;text-align:center">No verdicts yet</div>';
  }

  // ── Agent state ──
  function onAgentState(p) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.agentState = p.state || "listening";
    var prevMode = c.mode;
    if (p.mode) c.mode = p.mode;

    if (p.state === "waiting") {
      if (!c._prevWaiting) { c._prevWaiting = true; renderSidebar(); }
    } else {
      if (c._prevWaiting) { c._prevWaiting = false; renderSidebar(); }
    }

    if (p.mode && p.mode !== prevMode) { renderSidebar(); renderModeToggle(); }

    if (cid === selectedCallId) {
      var displayState = p.mode === "takeover" ? "takeover" : (p.state || "\u2014");
      stateBadge.setAttribute("data-state", displayState);
      stateLabel.textContent = displayState.charAt(0).toUpperCase() + displayState.slice(1);
    }
  }

  // ── Guidance ──
  function onGuidanceRequest(p) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.guidanceRequests.set(p.request_id, { question: p.question, requestId: p.request_id, resolved: false, response: "" });
    c._prevWaiting = true;
    renderSidebar();
    if (cid === selectedCallId) {
      renderGuidanceCard(p);
      // Auto-focus the main input bar so operator can respond immediately
      cmdInput.focus();
      cmdInput.placeholder = "Type response to speak to caller...";
    }
  }

  var MIC_SVG = '<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';
  var STOP_SVG = '<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>';

  function renderGuidanceCard(p) {
    if (transcriptEmpty && transcriptEmpty.parentNode) transcriptEmpty.remove();
    var el = document.createElement("div");
    el.className = "guidance-card";
    el.id = "gc-" + p.request_id;

    var html = '<div class="guidance-header">';
    html += '<div class="guidance-pulse"></div>';
    html += '<span class="guidance-label">Guidance Requested</span>';
    html += '</div>';
    html += '<div class="guidance-question">' + esc(p.question) + '</div>';
    html += '<div class="guidance-mic-row">';
    html += '<button class="guidance-mic" data-rid="' + esc(p.request_id) + '" data-cid="' + esc(p.call_id || "") + '">' + MIC_SVG + '</button>';
    html += '<span class="guidance-mic-label">Click to respond by voice</span>';
    html += '</div>';

    el.innerHTML = html;
    transcript.appendChild(el);

    var micBtn = el.querySelector(".guidance-mic");
    micBtn.addEventListener("click", function() { toggleGuidanceRecording(p.call_id || selectedCallId, p.request_id, micBtn, el); });

    if (autoScroll) scrollBottom();
    else scrollPill.classList.add("visible");
  }

  var activeRecorder = null;

  function toggleGuidanceRecording(callId, requestId, micBtn, card) {
    if (micBtn.classList.contains("transcribing")) return;

    if (activeRecorder) {
      activeRecorder.stop();
      activeRecorder = null;
      return;
    }

    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
      var recorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
      var chunks = [];
      activeRecorder = recorder;

      micBtn.classList.add("recording");
      micBtn.innerHTML = STOP_SVG;
      micBtn.nextElementSibling.textContent = "Recording... click to send";

      recorder.ondataavailable = function(e) { chunks.push(e.data); };

      recorder.onstop = function() {
        stream.getTracks().forEach(function(t) { t.stop(); });
        activeRecorder = null;
        micBtn.classList.remove("recording");
        micBtn.classList.add("transcribing");
        micBtn.innerHTML = MIC_SVG;
        micBtn.nextElementSibling.textContent = "Transcribing...";

        var blob = new Blob(chunks, { type: "audio/webm" });
        var reader = new FileReader();
        reader.onloadend = function() {
          var b64 = reader.result.split(",")[1];
          send({
            type: "voice_input",
            payload: { audio: b64, request_id: requestId, call_id: callId }
          });
        };
        reader.readAsDataURL(blob);
      };

      recorder.start();
    }).catch(function(err) {
      showToast("Microphone access denied", false);
    });
  }

  function onVoiceTranscription(p) {
    var rid = p.request_id || "";
    var text = p.text || "";
    var cid = p.call_id || "";
    var card = document.getElementById("gc-" + rid);

    if (!text) {
      if (card) {
        var micBtn = card.querySelector(".guidance-mic");
        if (micBtn) {
          micBtn.classList.remove("transcribing");
          micBtn.nextElementSibling.textContent = "No speech detected — click to try again";
        }
      }
      return;
    }

    var c = getCall(cid);
    var gr = c.guidanceRequests.get(rid);
    if (gr) { gr.resolved = true; gr.response = text; }

    var anyPending = false;
    c.guidanceRequests.forEach(function(g) { if (!g.resolved) anyPending = true; });
    if (!anyPending) { c._prevWaiting = false; renderSidebar(); }

    if (card) {
      card.className = "guidance-card resolved";
      card.innerHTML = '<div class="guidance-header"><span class="guidance-label">Guidance Sent</span></div>'
        + '<div class="guidance-question">' + esc(gr ? gr.question : "") + '</div>'
        + '<div class="guidance-sent">Response: ' + esc(text) + '</div>';
    }
  }

  // ── Judge status ──
  function onJudgeStatus(p) {
    var cid = p.call_id || "";
    if (cid === selectedCallId || !selectedCallId) {
      var s = p.status || "idle";
      judgeBadge.setAttribute("data-judge", s);
      var labels = { evaluating: "Evaluating...", rule_caught: "Rule caught", idle: "Judge idle" };
      judgeLabel.textContent = labels[s] || s;
    }
  }

  // ── Context update ──
  function onContextUpdate(p) {
    var cid = p.call_id || "";
    var c = calls.get(cid);
    if (c && p.mode) c.mode = p.mode;
    if (cid === selectedCallId) { renderSidebar(); renderModeToggle(); }
  }

  // ── Call status (SIP dialing lifecycle) ──
  function onCallStatus(p) {
    var cid = p.call_id || "";
    var status = p.status || "";

    if (status === "dialing") {
      btnDial.disabled = true;
      btnDial.textContent = "Dialing...";
    } else if (status === "answered") {
      btnDial.disabled = false;
      btnDial.textContent = "Dial";
      btnHangUp.classList.add("visible");
      var c = calls.get(cid);
      if (c) c.label = (c.label || cid) + " (connected)";
      renderSidebar();
    } else if (status === "failed") {
      btnDial.disabled = false;
      btnDial.textContent = "Dial";
      showToast(p.error || "Call failed", false);
    } else if (status === "ended") {
      btnHangUp.classList.remove("visible");
      var c = calls.get(cid);
      if (c) c.status = "ended";
      renderSidebar();
    }
  }

  function showToast(msg, ok) {
    ackToast.textContent = msg;
    ackToast.className = "ack-toast visible " + (ok ? "ok" : "fail");
    clearTimeout(ackToast._timer);
    ackToast._timer = setTimeout(function(){ ackToast.classList.remove("visible"); }, 3000);
  }

  // ── Ack ──
  var ACK_LABELS = {
    inject_instruction: "Instruction injected",
    operator_speak: "Speaking to caller",
    set_mode: "Mode updated",
    guidance_response: "Guidance sent",
    dial_call: "Dialing...",
    hang_up: "Hanging up..."
  };
  var ACK_TYPES = {
    inject_instruction: "inject",
    operator_speak: "speak"
  };
  function onAck(p) {
    var cmd = p.command || "";
    var label = ACK_LABELS[cmd] || cmd;
    ackToast.textContent = (p.ok ? label : "Failed \u2014 " + label);
    var cls = "ack-toast visible ";
    if (!p.ok) { cls += "fail"; }
    else if (ACK_TYPES[cmd]) { cls += "ok-" + ACK_TYPES[cmd]; }
    else { cls += "ok"; }
    ackToast.className = cls;
    clearTimeout(ackToast._timer);
    ackToast._timer = setTimeout(function(){ ackToast.classList.remove("visible"); }, 2000);
  }

  // ── Select call ──
  function selectCall(callId) {
    selectedCallId = callId;
    renderSidebar();
    renderFullTranscript();
    renderModeToggle();

    var c = calls.get(callId);
    if (c) {
      callInfo.textContent = c.label;
      stateBadge.setAttribute("data-state", c.agentState);
      stateLabel.textContent = (c.agentState || "\u2014").charAt(0).toUpperCase() + (c.agentState || "").slice(1);
    }

    if (drawerOpen) {
      renderVerdictHistory(c || { verdicts: [] });
    }
  }

  // ── Mode toggle ──
  function renderModeToggle() {
    var c = selectedCallId ? calls.get(selectedCallId) : null;
    var mode = c ? c.mode : "llm";
    var btns = modeToggle.querySelectorAll(".mode-btn");
    btns.forEach(function(btn) {
      var m = btn.getAttribute("data-mode");
      btn.className = "mode-btn" + (m === mode ? " active-" + m : "");
    });
  }

  modeToggle.addEventListener("click", function(e) {
    var btn = e.target.closest(".mode-btn");
    if (!btn || !selectedCallId) return;
    var newMode = btn.getAttribute("data-mode");
    var c = calls.get(selectedCallId);
    if (c && newMode !== c.mode) {
      c.mode = newMode;
      send({ type: "set_mode", payload: { mode: newMode, call_id: selectedCallId } });
      renderModeToggle();
      renderSidebar();
    }
  });

  // ── Sidebar rendering ──
  function renderSidebar() {
    var html = "";
    var count = 0;
    calls.forEach(function(c, cid) {
      count++;
      var sel = cid === selectedCallId;
      var waiting = c._prevWaiting && c.status !== "ended";
      var cls = "call-card";
      if (sel) cls += " selected";
      if (c.status === "ended") cls += " ended";
      if (waiting) cls += " waiting";

      var lastText = "";
      if (c.transcripts.length > 0) {
        lastText = trunc(c.transcripts[c.transcripts.length - 1].text, 40);
      }

      html += '<div class="' + cls + '" data-cid="' + esc(cid) + '">';
      html += '<div class="call-dot-wrap"><div class="call-dot"></div></div>';
      html += '<div class="call-body">';
      html += '<div class="call-label">' + esc(c.label) + '</div>';
      html += '<div class="call-meta">';
      html += '<span class="call-mode-badge ' + c.mode + '">' + esc(c.mode) + '</span>';
      html += '</div>';
      if (lastText) html += '<div class="call-snippet">' + esc(lastText) + '</div>';
      html += '</div>';

      if (c.highestRisk && c.highestRisk !== "none" && c.highestRisk !== "low") {
        html += '<div class="call-risk"><div class="call-risk-dot ' + c.highestRisk + '"></div></div>';
      }

      html += '</div>';
    });

    callsList.innerHTML = html || '<div class="calls-empty">No active calls</div>';
    callCount.textContent = count > 0 ? count : "";

    callsList.querySelectorAll(".call-card").forEach(function(el){
      el.addEventListener("click", function(){
        selectCall(el.getAttribute("data-cid"));
      });
    });
  }

  // ── Full re-renders ──
  function renderFullTranscript() {
    transcript.innerHTML = "";
    var c = calls.get(selectedCallId);
    if (!c || c.transcripts.length === 0) {
      transcript.innerHTML = '<div class="transcript-empty">Waiting for data...</div>';
      return;
    }

    for (var i = 0; i < c.transcripts.length; i++) {
      var t = c.transcripts[i];
      renderTranscriptItem({ speaker: t.speaker, text: t.text, turn_id: t.turnId }, t.ts, c);
    }

    c.guidanceRequests.forEach(function(gr){
      if (gr.resolved) {
        var el = document.createElement("div");
        el.className = "guidance-card resolved";
        el.innerHTML = '<div class="guidance-header"><span class="guidance-label">Guidance Sent</span></div>'
          + '<div class="guidance-question">' + esc(gr.question) + '</div>'
          + '<div class="guidance-sent">Response: ' + esc(gr.response) + '</div>';
        transcript.appendChild(el);
      } else {
        renderGuidanceCard({ call_id: selectedCallId, question: gr.question, request_id: gr.requestId });
      }
    });

    scrollBottom();
  }

  // ── Dial / Hang Up ──
  btnDial.addEventListener("click", function() {
    var phone = phoneInput.value.trim();
    if (!phone) { phoneInput.focus(); return; }
    var domain = domainSelect.value;
    btnDial.disabled = true;
    btnDial.textContent = "Dialing...";
    send({ type: "dial_call", payload: { phone_number: phone, domain: domain } });
  });

  phoneInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") { e.preventDefault(); btnDial.click(); }
  });

  btnHangUp.addEventListener("click", function() {
    if (selectedCallId) {
      send({ type: "hang_up", payload: { call_id: selectedCallId } });
    }
  });

  // ── Verdict drawer ──
  btnVerdictHistory.addEventListener("click", function() {
    drawerOpen = !drawerOpen;
    verdictDrawer.classList.toggle("open", drawerOpen);
    btnVerdictHistory.classList.toggle("active", drawerOpen);
    if (drawerOpen) {
      var c = selectedCallId ? calls.get(selectedCallId) : null;
      renderVerdictHistory(c || { verdicts: [] });
    }
  });

  drawerHandle.addEventListener("click", function() {
    drawerOpen = false;
    verdictDrawer.classList.remove("open");
    btnVerdictHistory.classList.remove("active");
  });

  // ── Input commands ──
  function getInput() {
    var v = cmdInput.value.trim();
    if (!v) return null;
    cmdInput.value = "";
    return v;
  }

  function flashBtn(btn) {
    btn.classList.add("sent");
    setTimeout(function(){ btn.classList.remove("sent"); }, 300);
    var bar = cmdInput.closest(".inputbar");
    if (bar) { bar.classList.remove("flash"); void bar.offsetWidth; bar.classList.add("flash"); }
  }

  btnInject.addEventListener("click", function(){
    var t = getInput(); if (t) { flashBtn(btnInject); send({ type: "inject_instruction", payload: { instruction: t } }); }
  });
  btnSpeak.addEventListener("click", function(){
    var t = getInput(); if (t) { flashBtn(btnSpeak); send({ type: "operator_speak", payload: { text: t } }); }
  });
  cmdInput.addEventListener("keydown", function(e){
    if (e.key === "Enter" && e.shiftKey) {
      e.preventDefault();
      var t = getInput(); if (t) { flashBtn(btnSpeak); send({ type: "operator_speak", payload: { text: t } }); }
    } else if (e.key === "Enter" && !e.shiftKey && !e.ctrlKey) {
      e.preventDefault();
      var t = getInput(); if (t) { flashBtn(btnInject); send({ type: "inject_instruction", payload: { instruction: t } }); }
    }
  });

  // ── Filters ──
  filterAll.addEventListener("click", function(){
    filterMode = "all";
    filterAll.className = "filter-tab active";
    filterFlagged.className = "filter-tab";
    renderFullTranscript();
  });
  filterFlagged.addEventListener("click", function(){
    filterMode = "flagged";
    filterFlagged.className = "filter-tab active-flagged";
    filterAll.className = "filter-tab";
    renderFullTranscript();
  });

  // ── Scroll ──
  transcript.addEventListener("scroll", function(){
    var gap = transcript.scrollHeight - transcript.scrollTop - transcript.clientHeight;
    autoScroll = gap < 50;
    if (autoScroll) scrollPill.classList.remove("visible");
  });
  scrollPill.addEventListener("click", function(){
    scrollBottom(); autoScroll = true; scrollPill.classList.remove("visible");
  });
  function scrollBottom() { transcript.scrollTop = transcript.scrollHeight; }

  // ── Util ──
  function esc(s) {
    if (!s) return "";
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function fmtTime(ts) {
    if (!ts) return "";
    var d = new Date(ts * 1000);
    return d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }
  function trunc(s, n) { return s && s.length > n ? s.slice(0, n) + "\u2026" : (s || ""); }

  // ── Init ──
  connect();
})();
</script>

</body>
</html>