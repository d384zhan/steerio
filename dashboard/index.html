<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STEERIO // CONTROL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --black: #0a0a0a;
  --dark: #111;
  --panel: #161616;
  --border: #2a2a2a;
  --border-hi: #444;
  --text: #ddd;
  --text-dim: #666;
  --text-ghost: #3a3a3a;
  --red: #ff2020;
  --red-dim: #331010;
  --green: #00e060;
  --green-dim: #0a2a15;
  --amber: #ffaa00;
  --amber-dim: #2a1e00;
  --blue: #4488ff;
  --white: #fff;
  --mono: 'IBM Plex Mono', 'SF Mono', 'Cascadia Code', Consolas, monospace;
}

html, body {
  height: 100%;
  font-family: var(--mono);
  background: var(--black);
  color: var(--text);
  overflow: hidden;
  font-size: 12px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ═══════════════════════════════════════════════════════════
   LAYOUT — rigid grid, no flex, no flow
   ═══════════════════════════════════════════════════════════ */
.app {
  display: grid;
  grid-template-rows: 40px 1fr 52px;
  grid-template-columns: 200px 1fr 360px;
  grid-template-areas:
    "topbar     topbar     topbar"
    "calls      transcript verdict"
    "calls      inputbar   inputbar";
  height: 100vh;
  width: 100vw;
}

/* ═══════════════════════════════════════════════════════════
   TOP BAR
   ═══════════════════════════════════════════════════════════ */
.topbar {
  grid-area: topbar;
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 0 16px;
  background: var(--dark);
  border-bottom: 2px solid var(--border-hi);
}

.logo {
  font-weight: 700;
  font-size: 14px;
  letter-spacing: 4px;
  color: var(--white);
  text-transform: uppercase;
}

.logo-sub {
  color: var(--text-dim);
  font-weight: 400;
  letter-spacing: 2px;
  font-size: 10px;
  margin-left: 8px;
}

.topbar-spacer { flex: 1; }

.top-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-dim);
}

.conn-dot {
  width: 6px;
  height: 6px;
  background: var(--text-dim);
}

.conn-dot.connected { background: var(--green); }
.conn-dot.disconnected { background: var(--red); }

/* Agent state */
.state-box {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--border);
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-dim);
}

.state-indicator {
  width: 8px;
  height: 8px;
  background: var(--text-dim);
}

.state-box[data-state="listening"] .state-indicator {
  background: var(--green);
  animation: pulse-slow 2s linear infinite;
}
.state-box[data-state="thinking"] .state-indicator {
  background: var(--amber);
  animation: blink-fast 0.4s step-start infinite;
}
.state-box[data-state="speaking"] .state-indicator {
  background: var(--blue);
  animation: ring-expand 0.8s linear infinite;
}
.state-box[data-state="waiting"] .state-indicator {
  background: var(--amber);
  animation: glow-amber 1.2s linear infinite;
}
.state-box[data-state="takeover"] .state-indicator {
  background: var(--red);
  animation: pulse-slow 1.5s linear infinite;
}

@keyframes pulse-slow {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 1; }
}
@keyframes blink-fast {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}
@keyframes ring-expand {
  0% { box-shadow: 0 0 0 0 var(--blue); }
  100% { box-shadow: 0 0 0 6px transparent; }
}
@keyframes glow-amber {
  0%, 100% { box-shadow: 0 0 2px var(--amber); }
  50% { box-shadow: 0 0 8px var(--amber); }
}

/* ═══════════════════════════════════════════════════════════
   CALLS SIDEBAR
   ═══════════════════════════════════════════════════════════ */
.calls-panel {
  grid-area: calls;
  background: var(--dark);
  border-right: 2px solid var(--border-hi);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.calls-header {
  padding: 10px 12px;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.calls-list { flex: 1; }

.call-item {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  border-left: 3px solid transparent;
  cursor: pointer;
  transition: none;
}

.call-item:hover { background: var(--panel); }

.call-item.selected {
  background: var(--panel);
  border-left-color: var(--white);
}

.call-item.ended { opacity: 0.35; }

.call-top {
  display: flex;
  align-items: center;
  gap: 8px;
}

.call-dot {
  width: 6px;
  height: 6px;
  flex-shrink: 0;
  background: var(--green);
}

.call-item.ended .call-dot { background: var(--text-dim); }
.call-item.waiting .call-dot {
  background: var(--amber);
  animation: glow-amber 1.2s linear infinite;
}

.call-label {
  font-size: 11px;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex: 1;
}

.call-id-tag {
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 0.5px;
  margin-top: 2px;
}

/* Per-call mode toggle */
.call-mode {
  display: flex;
  margin-top: 6px;
  border: 1px solid var(--border);
}

.call-mode-btn {
  flex: 1;
  padding: 3px 0;
  background: transparent;
  border: none;
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
}

.call-mode-btn + .call-mode-btn { border-left: 1px solid var(--border); }

.call-mode-btn.active-llm { background: var(--blue); color: var(--black); }
.call-mode-btn.active-human { background: var(--amber); color: var(--black); }
.call-mode-btn.active-takeover { background: var(--red); color: var(--white); }

.calls-empty {
  padding: 20px 12px;
  color: var(--text-dim);
  font-size: 10px;
  letter-spacing: 0.5px;
}

/* ═══════════════════════════════════════════════════════════
   TRANSCRIPT
   ═══════════════════════════════════════════════════════════ */
.transcript-panel {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  background: var(--black);
}

.transcript-panel::-webkit-scrollbar { width: 4px; }
.transcript-panel::-webkit-scrollbar-track { background: transparent; }
.transcript-panel::-webkit-scrollbar-thumb { background: var(--border); }

.transcript-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-ghost);
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.scroll-pill {
  position: fixed;
  bottom: 62px;
  left: calc(200px + (100vw - 200px - 360px) / 2 - 60px);
  background: var(--panel);
  color: var(--text-dim);
  border: 1px solid var(--border-hi);
  padding: 4px 12px;
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s linear;
}
.scroll-pill.visible { opacity: 1; pointer-events: auto; }
.scroll-pill:hover { border-color: var(--white); color: var(--white); }

/* Messages */
.msg {
  max-width: 75%;
  padding: 6px 10px;
  border: 1px solid var(--border);
  font-size: 12px;
  line-height: 1.55;
  word-break: break-word;
  animation: msg-in 0.1s linear;
}

@keyframes msg-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.msg.user {
  align-self: flex-start;
  border-left: 3px solid var(--text-dim);
}

.msg.agent {
  align-self: flex-end;
  border-right: 3px solid var(--blue);
}

.msg.system {
  align-self: center;
  border: 1px dashed var(--amber);
  color: var(--amber);
  max-width: 85%;
  text-align: center;
}

.msg.flagged {
  background: var(--red-dim);
  border-color: var(--red);
  border-width: 2px;
  position: relative;
}
.msg.flagged .msg-text { color: var(--red); }
.msg.flagged::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 0;
  height: 0;
  border-top: 16px solid var(--red);
  border-left: 16px solid transparent;
}

.msg.blocked {
  background: rgba(255,32,32,0.06);
  border-color: var(--red);
  border-style: dashed;
}
.msg.blocked .msg-text {
  text-decoration: line-through;
  opacity: 0.4;
}

.msg.flagged .verdict-inline {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border);
  font-size: 9px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-dim);
}
.verdict-inline .action-tag {
  padding: 1px 6px;
  font-weight: 700;
  letter-spacing: 1px;
}
.action-tag.block { background: var(--red); color: var(--white); }
.action-tag.modify { background: var(--amber); color: var(--black); }
.action-tag.escalate { background: var(--red); color: var(--white); }

.msg.operator {
  align-self: center;
  border: 2px solid var(--green);
  background: var(--green-dim);
  max-width: 85%;
}
.msg.operator .msg-speaker { color: var(--green); }

/* Filter bar */
.transcript-filter {
  display: flex;
  align-items: center;
  gap: 0;
  padding: 0;
  background: var(--dark);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.filter-btn {
  padding: 6px 14px;
  background: transparent;
  border: none;
  border-right: 1px solid var(--border);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
}
.filter-btn:hover { color: var(--text); }
.filter-btn.active { color: var(--white); border-bottom: 2px solid var(--white); }
.filter-btn.active-flagged { color: var(--red); border-bottom: 2px solid var(--red); }

.msg .corrective {
  display: block;
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border);
  color: var(--green);
  text-decoration: none;
}

.msg-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 2px;
}

.msg-speaker {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-dim);
}

.msg-time {
  font-size: 9px;
  color: var(--text-ghost);
}

.risk-badge {
  font-size: 9px;
  font-weight: 700;
  padding: 0 6px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--black);
}
.risk-badge.high { background: #ff6020; }
.risk-badge.critical { background: var(--red); }

/* Guidance card */
.guidance-card {
  align-self: center;
  max-width: 90%;
  width: 100%;
  padding: 12px;
  border: 2px solid var(--amber);
  background: var(--amber-dim);
  animation: msg-in 0.1s linear;
}

.guidance-card.resolved {
  border-color: var(--border);
  background: transparent;
  opacity: 0.5;
}

.guidance-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--amber);
  margin-bottom: 6px;
}

.guidance-card.resolved .guidance-label { color: var(--green); }

.guidance-question {
  font-size: 12px;
  color: var(--text);
  margin-bottom: 8px;
  line-height: 1.5;
}

.guidance-input-row {
  display: flex;
  gap: 0;
}

.guidance-input {
  flex: 1;
  height: 30px;
  padding: 0 8px;
  background: var(--black);
  border: 1px solid var(--border-hi);
  color: var(--text);
  font-family: var(--mono);
  font-size: 11px;
  outline: none;
}
.guidance-input:focus { border-color: var(--amber); }

.guidance-send {
  height: 30px;
  padding: 0 14px;
  background: var(--amber);
  border: none;
  color: var(--black);
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
}
.guidance-send:hover { background: var(--white); }

.guidance-sent {
  font-size: 11px;
  color: var(--green);
  margin-top: 6px;
}

/* ═══════════════════════════════════════════════════════════
   VERDICT PANEL
   ═══════════════════════════════════════════════════════════ */
.verdict-panel {
  grid-area: verdict;
  background: var(--dark);
  border-left: 2px solid var(--border-hi);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.verdict-section-label {
  padding: 10px 14px;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.verdict-latest {
  padding: 14px;
  border-bottom: 2px solid var(--border);
  flex-shrink: 0;
  min-height: 100px;
}

.verdict-empty {
  color: var(--text-ghost);
  font-size: 11px;
  padding: 10px 0;
}

.verdict-card {
  border: 1px solid var(--border);
  padding: 10px;
  animation: msg-in 0.1s linear;
}

.verdict-top-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.verdict-risk-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 1px 8px;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.verdict-risk-badge.none { background: var(--green); color: var(--black); }
.verdict-risk-badge.low { background: var(--blue); color: var(--black); }
.verdict-risk-badge.medium { background: var(--amber); color: var(--black); }
.verdict-risk-badge.high { background: #ff6020; color: var(--black); }
.verdict-risk-badge.critical { background: var(--red); color: var(--white); }

.verdict-action-label {
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-dim);
  font-weight: 600;
}

.verdict-reasoning {
  font-size: 11px;
  color: var(--text-dim);
  line-height: 1.5;
}

.verdict-corrective {
  font-size: 11px;
  color: var(--green);
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid var(--border);
}

.verdict-time {
  font-size: 9px;
  color: var(--text-ghost);
  margin-top: 6px;
}

/* Verdict history */
.verdict-history {
  flex: 1;
  overflow-y: auto;
  padding: 6px 14px;
}

.verdict-history::-webkit-scrollbar { width: 3px; }
.verdict-history::-webkit-scrollbar-track { background: transparent; }
.verdict-history::-webkit-scrollbar-thumb { background: var(--border); }

.vh-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 6px;
  font-size: 10px;
  color: var(--text-dim);
  border-bottom: 1px solid var(--border);
}

.vh-dot {
  width: 5px;
  height: 5px;
  flex-shrink: 0;
}
.vh-dot.none { background: var(--green); }
.vh-dot.low { background: var(--blue); }
.vh-dot.medium { background: var(--amber); }
.vh-dot.high { background: #ff6020; }
.vh-dot.critical { background: var(--red); }

.vh-action {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.vh-time {
  font-size: 9px;
  color: var(--text-ghost);
  flex-shrink: 0;
}

/* ═══════════════════════════════════════════════════════════
   INPUT BAR
   ═══════════════════════════════════════════════════════════ */
.inputbar {
  grid-area: inputbar;
  display: flex;
  align-items: center;
  gap: 0;
  background: var(--dark);
  border-top: 2px solid var(--border-hi);
}

.inputbar input {
  flex: 1;
  height: 52px;
  padding: 0 14px;
  background: var(--black);
  border: none;
  border-right: 1px solid var(--border);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  outline: none;
}

.inputbar input::placeholder { color: var(--text-ghost); }

.inputbar button {
  height: 52px;
  padding: 0 20px;
  background: transparent;
  border: none;
  border-right: 1px solid var(--border);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  transition: none;
}

.inputbar button:hover {
  color: var(--black);
}

.btn-inject:hover { background: var(--blue); }
.btn-override:hover { background: var(--red); }
.btn-speak { border-left: 2px solid var(--border-hi); }
.btn-speak:hover { background: var(--green); }

.shortcut-hint {
  padding: 0 14px;
  font-size: 9px;
  color: var(--text-ghost);
  letter-spacing: 0.5px;
  white-space: nowrap;
}

/* ═══════════════════════════════════════════════════════════
   ACK TOAST
   ═══════════════════════════════════════════════════════════ */
.ack-toast {
  position: fixed;
  top: 50px;
  right: 16px;
  padding: 6px 14px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  z-index: 100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.1s linear;
}
.ack-toast.visible { opacity: 1; }
.ack-toast.ok { background: var(--green); color: var(--black); }
.ack-toast.fail { background: var(--red); color: var(--white); }

/* ═══════════════════════════════════════════════════════════
   JUDGE STATUS INDICATOR
   ═══════════════════════════════════════════════════════════ */
.judge-status {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border: 1px solid var(--border);
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-dim);
}

.judge-dot {
  width: 8px;
  height: 8px;
  background: var(--text-dim);
}

.judge-status[data-judge="evaluating"] .judge-dot {
  background: var(--amber);
  animation: blink-fast 0.4s step-start infinite;
}
.judge-status[data-judge="evaluating"] {
  color: var(--amber);
  border-color: var(--amber);
}

.judge-status[data-judge="rule_caught"] .judge-dot {
  background: var(--red);
}
.judge-status[data-judge="rule_caught"] {
  color: var(--red);
  border-color: var(--red);
}

.judge-status[data-judge="idle"] .judge-dot {
  background: var(--text-dim);
}

/* ═══════════════════════════════════════════════════════════
   RELOAD BUTTON
   ═══════════════════════════════════════════════════════════ */
.btn-reload {
  background: transparent;
  border-color: var(--border);
}
.btn-reload:hover { background: var(--green); }

/* ═══════════════════════════════════════════════════════════
   SCANLINE — subtle CRT texture
   ═══════════════════════════════════════════════════════════ */
.app::after {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 9999;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0,0,0,0.03) 2px,
    rgba(0,0,0,0.03) 4px
  );
}
</style>
</head>
<body>

<div class="app">

  <div class="topbar">
    <span class="logo">STEERIO<span class="logo-sub">// CONTROL</span></span>
    <div class="topbar-spacer"></div>
    <div class="judge-status" id="judgeStatus" data-judge="idle">
      <div class="judge-dot"></div>
      <span id="judgeLabel">JUDGE IDLE</span>
    </div>
    <div class="state-box" id="stateBox" data-state="">
      <div class="state-indicator"></div>
      <span id="stateLabel">—</span>
    </div>
    <div class="top-item">
      <div class="conn-dot" id="connDot"></div>
      <span id="connLabel">—</span>
    </div>
  </div>

  <div class="calls-panel">
    <div class="calls-header">CALLS</div>
    <div class="calls-list" id="callsList">
      <div class="calls-empty" id="callsEmpty">NO ACTIVE CALLS</div>
    </div>
  </div>

  <div style="grid-area: transcript; display: flex; flex-direction: column; overflow: hidden;">
    <div class="transcript-filter">
      <button class="filter-btn active" id="filterAll">ALL</button>
      <button class="filter-btn" id="filterFlagged">FLAGGED</button>
    </div>
    <div class="transcript-panel" id="transcript">
      <div class="transcript-empty" id="transcriptEmpty">SELECT A CALL</div>
    </div>
  </div>

  <div class="verdict-panel">
    <div class="verdict-section-label">VERDICT</div>
    <div class="verdict-latest" id="verdictLatest">
      <div class="verdict-empty">NO VERDICTS</div>
    </div>
    <div class="verdict-section-label">HISTORY</div>
    <div class="verdict-history" id="verdictHistory"></div>
  </div>

  <div class="inputbar">
    <input type="text" id="cmdInput" placeholder="OPERATOR INSTRUCTION..." autocomplete="off" />
    <button class="btn-inject" id="btnInject">INJECT</button>
    <button class="btn-override" id="btnOverride">OVERRIDE</button>
    <button class="btn-speak" id="btnSpeak">SPEAK</button>
    <button class="btn-reload" id="btnReload">RELOAD</button>
    <span class="shortcut-hint">ENTER=INJECT // SHIFT=OVERRIDE // CTRL=SPEAK</span>
  </div>

</div>

<div class="scroll-pill" id="scrollPill">NEW MESSAGES</div>
<div class="ack-toast" id="ackToast"></div>

<script>
(function(){
  "use strict";

  // ── DOM ──
  var transcript = document.getElementById("transcript");
  var transcriptEmpty = document.getElementById("transcriptEmpty");
  var scrollPill = document.getElementById("scrollPill");
  var verdictLatest = document.getElementById("verdictLatest");
  var verdictHistory = document.getElementById("verdictHistory");
  var connDot = document.getElementById("connDot");
  var connLabel = document.getElementById("connLabel");
  var stateBox = document.getElementById("stateBox");
  var stateLabel = document.getElementById("stateLabel");
  var callsList = document.getElementById("callsList");
  var callsEmpty = document.getElementById("callsEmpty");
  var cmdInput = document.getElementById("cmdInput");
  var btnInject = document.getElementById("btnInject");
  var btnOverride = document.getElementById("btnOverride");
  var btnSpeak = document.getElementById("btnSpeak");
  var btnReload = document.getElementById("btnReload");
  var filterAll = document.getElementById("filterAll");
  var filterFlagged = document.getElementById("filterFlagged");
  var judgeStatus = document.getElementById("judgeStatus");
  var judgeLabel = document.getElementById("judgeLabel");
  var ackToast = document.getElementById("ackToast");

  // ── State ──
  var ws = null;
  var autoScroll = true;
  var selectedCallId = null;
  var filterMode = "all"; // "all" or "flagged"
  // calls: Map<callId, {label, status, mode, agentState, transcripts[], verdicts[], guidanceRequests: Map, pendingVerdict}>
  var calls = new Map();

  function getCall(callId) {
    if (!calls.has(callId)) {
      calls.set(callId, {
        label: callId,
        status: "active",
        mode: "llm",
        agentState: "listening",
        transcripts: [],
        verdicts: [],
        guidanceRequests: new Map(),
        pendingVerdict: null
      });
    }
    return calls.get(callId);
  }

  // ── WebSocket ──
  function connect() {
    setConn("connecting");
    ws = new WebSocket("ws://localhost:8766/ws");
    ws.onopen = function(){ setConn("connected"); };
    ws.onclose = function(){ setConn("disconnected"); setTimeout(connect, 2000); };
    ws.onerror = function(){ setConn("disconnected"); };
    ws.onmessage = function(e){
      try { handleMessage(JSON.parse(e.data)); } catch(_){}
    };
  }

  function setConn(s) {
    connDot.className = "conn-dot " + s;
    connLabel.textContent = s.toUpperCase();
  }

  function send(obj) {
    if (!ws || ws.readyState !== 1) return;
    obj.ts = Date.now() / 1000;
    if (selectedCallId && obj.payload) obj.payload.call_id = selectedCallId;
    ws.send(JSON.stringify(obj));
  }

  // ── Dispatch ──
  function handleMessage(msg) {
    var p = msg.payload || {};
    switch(msg.type) {
      case "call_started": onCallStarted(p); break;
      case "call_ended": onCallEnded(p); break;
      case "transcript": onTranscript(p, msg.ts); break;
      case "verdict": onVerdict(p, msg.ts); break;
      case "agent_state": onAgentState(p); break;
      case "guidance_request": onGuidanceRequest(p); break;
      case "judge_status": onJudgeStatus(p); break;
      case "context_update": onContextUpdate(p); break;
      case "ack": onAck(p); break;
    }
  }

  // ── Call lifecycle ──
  function onCallStarted(p) {
    var c = getCall(p.call_id);
    c.label = p.label || p.call_id;
    c.status = "active";
    if (!selectedCallId) selectCall(p.call_id);
    renderSidebar();
  }

  function onCallEnded(p) {
    var c = calls.get(p.call_id);
    if (c) { c.status = "ended"; renderSidebar(); }
  }

  // ── Transcript ──
  function onTranscript(p, ts) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.transcripts.push({ speaker: p.speaker, text: p.text, ts: ts, turnId: p.turn_id });
    if (cid === selectedCallId) renderTranscriptItem(p, ts, c);
  }

  function renderTranscriptItem(p, ts, call) {
    if (transcriptEmpty && transcriptEmpty.parentNode) transcriptEmpty.remove();

    var isAgent = p.speaker === "agent";
    var isSystem = p.speaker === "system";
    var isOperator = isSystem && p.text && p.text.indexOf("[OPERATOR]") === 0;
    var v = isAgent ? call.pendingVerdict : null;
    if (isAgent) call.pendingVerdict = null;

    var flagged = v && (v.risk_level === "high" || v.risk_level === "critical");
    var blocked = v && v.action === "block";
    var modified = v && v.action === "modify";
    var escalated = v && v.action === "escalate";

    // In flagged-only filter, skip non-flagged messages
    if (filterMode === "flagged" && !flagged) return;

    var el = document.createElement("div");
    var cls = "msg";
    if (isOperator) cls += " operator";
    else if (isSystem) cls += " system";
    else if (isAgent) cls += " agent";
    else cls += " user";
    if (flagged) cls += " flagged";
    if (blocked) cls += " blocked";
    el.className = cls;

    var speakerLabel = isOperator ? "OPERATOR" : p.speaker;
    var html = '<div class="msg-meta">';
    html += '<span class="msg-speaker">' + esc(speakerLabel) + '</span>';
    html += '<span class="msg-time">' + fmtTime(ts) + '</span>';
    if (flagged) html += ' <span class="risk-badge ' + v.risk_level + '">' + esc(v.risk_level) + '</span>';
    html += '</div>';
    var displayText = isOperator ? p.text.replace("[OPERATOR] ", "") : p.text;
    html += '<span class="msg-text">' + esc(displayText) + '</span>';
    if (blocked && v.corrective_instruction) {
      html += '<span class="corrective">' + esc(v.corrective_instruction) + '</span>';
    }
    // Inline verdict details for flagged messages
    if (flagged && v) {
      html += '<div class="verdict-inline">';
      html += '<span class="action-tag ' + v.action + '">' + esc(v.action) + '</span>';
      if (v.reasoning) html += '<span>' + esc(trunc(v.reasoning, 60)) + '</span>';
      html += '</div>';
    }

    el.innerHTML = html;
    transcript.appendChild(el);

    if (autoScroll) scrollBottom();
    else scrollPill.classList.add("visible");
  }

  // ── Verdict ──
  function onVerdict(p, ts) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.pendingVerdict = p;
    c.verdicts.unshift({ v: p, ts: ts });
    // Reset judge status to idle when verdict arrives
    if (cid === selectedCallId || !selectedCallId) {
      judgeStatus.setAttribute("data-judge", "idle");
      judgeLabel.textContent = "JUDGE IDLE";
    }
    if (c.verdicts.length > 20) c.verdicts.pop();
    if (cid === selectedCallId) {
      renderLatestVerdict(p, ts);
      renderVerdictHistory(c);
    }
  }

  function renderLatestVerdict(v, ts) {
    var html = '<div class="verdict-card">';
    html += '<div class="verdict-top-row">';
    html += '<span class="verdict-risk-badge ' + v.risk_level + '">' + esc(v.risk_level) + '</span>';
    html += '<span class="verdict-action-label">' + esc(v.action) + '</span>';
    html += '</div>';
    if (v.reasoning) html += '<div class="verdict-reasoning">' + esc(v.reasoning) + '</div>';
    if (v.corrective_instruction) html += '<div class="verdict-corrective">' + esc(v.corrective_instruction) + '</div>';
    html += '<div class="verdict-time">' + fmtTime(ts) + '</div>';
    html += '</div>';
    verdictLatest.innerHTML = html;
  }

  function renderVerdictHistory(call) {
    var html = "";
    for (var i = 0; i < call.verdicts.length; i++) {
      var item = call.verdicts[i];
      html += '<div class="vh-item">';
      html += '<span class="vh-dot ' + item.v.risk_level + '"></span>';
      html += '<span class="vh-action">' + esc(item.v.action);
      if (item.v.reasoning) html += ' — ' + esc(trunc(item.v.reasoning, 35));
      html += '</span>';
      html += '<span class="vh-time">' + fmtTime(item.ts) + '</span>';
      html += '</div>';
    }
    verdictHistory.innerHTML = html;
  }

  // ── Agent state ──
  function onAgentState(p) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.agentState = p.state || "listening";
    var prevMode = c.mode;
    if (p.mode) c.mode = p.mode;

    // Update call waiting status for sidebar
    if (p.state === "waiting") {
      if (!c._prevWaiting) { c._prevWaiting = true; renderSidebar(); }
    } else {
      if (c._prevWaiting) { c._prevWaiting = false; renderSidebar(); }
    }

    // Re-render sidebar if mode changed (to update toggle buttons)
    if (p.mode && p.mode !== prevMode) renderSidebar();

    if (cid === selectedCallId) {
      var displayState = p.mode === "takeover" ? "takeover" : (p.state || "—");
      stateBox.setAttribute("data-state", displayState);
      stateLabel.textContent = displayState.toUpperCase();
    }
  }

  // ── Guidance ──
  function onGuidanceRequest(p) {
    var cid = p.call_id || "";
    var c = getCall(cid);
    c.guidanceRequests.set(p.request_id, { question: p.question, requestId: p.request_id, resolved: false, response: "" });
    c._prevWaiting = true;
    renderSidebar();
    if (cid === selectedCallId) renderGuidanceCard(p);
  }

  function renderGuidanceCard(p) {
    if (transcriptEmpty && transcriptEmpty.parentNode) transcriptEmpty.remove();
    var el = document.createElement("div");
    el.className = "guidance-card";
    el.id = "gc-" + p.request_id;

    var html = '<div class="guidance-label">GUIDANCE REQUEST</div>';
    html += '<div class="guidance-question">' + esc(p.question) + '</div>';
    html += '<div class="guidance-input-row">';
    html += '<input class="guidance-input" id="gi-' + esc(p.request_id) + '" placeholder="TYPE RESPONSE..." />';
    html += '<button class="guidance-send" data-rid="' + esc(p.request_id) + '" data-cid="' + esc(p.call_id) + '">SEND</button>';
    html += '</div>';

    el.innerHTML = html;
    transcript.appendChild(el);

    // Wire events
    var btn = el.querySelector(".guidance-send");
    var inp = el.querySelector(".guidance-input");
    btn.addEventListener("click", function(){ submitGuidance(p.call_id, p.request_id, inp, el); });
    inp.addEventListener("keydown", function(e){
      if (e.key === "Enter") { e.preventDefault(); submitGuidance(p.call_id, p.request_id, inp, el); }
    });
    inp.focus();

    if (autoScroll) scrollBottom();
    else scrollPill.classList.add("visible");
  }

  function submitGuidance(callId, requestId, inp, card) {
    var text = inp.value.trim();
    if (!text) return;

    send({
      type: "guidance_response",
      payload: { request_id: requestId, response: text, call_id: callId }
    });

    var c = getCall(callId);
    var gr = c.guidanceRequests.get(requestId);
    if (gr) { gr.resolved = true; gr.response = text; }

    // Check if any unresolved remain
    var anyPending = false;
    c.guidanceRequests.forEach(function(g){ if (!g.resolved) anyPending = true; });
    if (!anyPending) { c._prevWaiting = false; renderSidebar(); }

    // Update card to resolved state
    card.className = "guidance-card resolved";
    card.innerHTML = '<div class="guidance-label">GUIDANCE SENT</div>'
      + '<div class="guidance-question">' + esc(c.guidanceRequests.get(requestId).question) + '</div>'
      + '<div class="guidance-sent">SENT: ' + esc(text) + '</div>';
  }

  // ── Judge status ──
  function onJudgeStatus(p) {
    var cid = p.call_id || "";
    if (cid === selectedCallId || !selectedCallId) {
      var s = p.status || "idle";
      judgeStatus.setAttribute("data-judge", s);
      var labels = { evaluating: "EVALUATING...", rule_caught: "RULE CAUGHT", idle: "JUDGE IDLE" };
      judgeLabel.textContent = labels[s] || s.toUpperCase();
    }
  }

  // ── Context update ──
  function onContextUpdate(p) {
    var cid = p.call_id || "";
    var c = calls.get(cid);
    if (c && p.mode) c.mode = p.mode;
    if (cid === selectedCallId) renderSidebar();
  }

  // ── Ack ──
  function onAck(p) {
    ackToast.textContent = (p.ok ? "OK" : "FAIL") + " // " + (p.command || "").toUpperCase();
    ackToast.className = "ack-toast visible " + (p.ok ? "ok" : "fail");
    clearTimeout(ackToast._timer);
    ackToast._timer = setTimeout(function(){ ackToast.classList.remove("visible"); }, 2000);
  }

  // ── Sidebar rendering ──
  function selectCall(callId) {
    selectedCallId = callId;
    renderSidebar();
    renderFullTranscript();
    renderFullVerdicts();

    var c = calls.get(callId);
    if (c) {
      stateBox.setAttribute("data-state", c.agentState);
      stateLabel.textContent = (c.agentState || "—").toUpperCase();
    }
  }

  function renderSidebar() {
    var html = "";
    var hasAny = false;
    calls.forEach(function(c, cid) {
      hasAny = true;
      var sel = cid === selectedCallId;
      var waiting = c._prevWaiting && c.status !== "ended";
      var cls = "call-item";
      if (sel) cls += " selected";
      if (c.status === "ended") cls += " ended";
      if (waiting) cls += " waiting";

      html += '<div class="' + cls + '" data-cid="' + esc(cid) + '">';
      html += '<div class="call-top"><div class="call-dot"></div>';
      html += '<span class="call-label">' + esc(c.label) + '</span></div>';
      html += '<div class="call-id-tag">' + esc(cid) + '</div>';

      if (sel) {
        html += '<div class="call-mode">';
        html += '<button class="call-mode-btn ' + (c.mode === "llm" ? "active-llm" : "") + '" data-call-mode="llm">LLM</button>';
        html += '<button class="call-mode-btn ' + (c.mode === "human" ? "active-human" : "") + '" data-call-mode="human">HUMAN</button>';
        html += '<button class="call-mode-btn ' + (c.mode === "takeover" ? "active-takeover" : "") + '" data-call-mode="takeover">TAKEOVER</button>';
        html += '</div>';
      }
      html += '</div>';
    });

    callsList.innerHTML = html;
    if (callsEmpty) {
      if (hasAny) { if (callsEmpty.parentNode) callsEmpty.remove(); }
    }
    if (!hasAny) {
      callsList.innerHTML = '<div class="calls-empty">NO ACTIVE CALLS</div>';
    }

    // Wire clicks
    callsList.querySelectorAll(".call-item").forEach(function(el){
      el.addEventListener("click", function(e){
        var modeBtn = e.target.closest(".call-mode-btn");
        if (modeBtn) {
          var newMode = modeBtn.getAttribute("data-call-mode");
          var cid = el.getAttribute("data-cid");
          var c = calls.get(cid);
          if (c && newMode !== c.mode) {
            c.mode = newMode;
            send({ type: "set_mode", payload: { mode: newMode, call_id: cid } });
            renderSidebar();
          }
          return;
        }
        selectCall(el.getAttribute("data-cid"));
      });
    });
  }

  // ── Full re-renders ──
  function renderFullTranscript() {
    // Clear
    transcript.innerHTML = "";
    var c = calls.get(selectedCallId);
    if (!c || c.transcripts.length === 0) {
      transcript.innerHTML = '<div class="transcript-empty">WAITING FOR DATA...</div>';
      return;
    }

    for (var i = 0; i < c.transcripts.length; i++) {
      var t = c.transcripts[i];
      renderTranscriptItem({ speaker: t.speaker, text: t.text, turn_id: t.turnId }, t.ts, c);
    }

    // Re-render guidance requests
    c.guidanceRequests.forEach(function(gr){
      if (gr.resolved) {
        var el = document.createElement("div");
        el.className = "guidance-card resolved";
        el.innerHTML = '<div class="guidance-label">GUIDANCE SENT</div>'
          + '<div class="guidance-question">' + esc(gr.question) + '</div>'
          + '<div class="guidance-sent">SENT: ' + esc(gr.response) + '</div>';
        transcript.appendChild(el);
      } else {
        renderGuidanceCard({ call_id: selectedCallId, question: gr.question, request_id: gr.requestId });
      }
    });

    scrollBottom();
  }

  function renderFullVerdicts() {
    var c = calls.get(selectedCallId);
    if (!c || c.verdicts.length === 0) {
      verdictLatest.innerHTML = '<div class="verdict-empty">NO VERDICTS</div>';
      verdictHistory.innerHTML = "";
      return;
    }
    renderLatestVerdict(c.verdicts[0].v, c.verdicts[0].ts);
    renderVerdictHistory(c);
  }

  // ── Mode toggle (topbar removed — per-call only in sidebar) ──

  // ── Input ──
  function getInput() {
    var v = cmdInput.value.trim();
    if (!v) return null;
    cmdInput.value = "";
    return v;
  }

  btnInject.addEventListener("click", function(){
    var t = getInput(); if (t) send({ type: "inject_instruction", payload: { instruction: t } });
  });
  btnOverride.addEventListener("click", function(){
    var t = getInput(); if (t) send({ type: "interrupt_and_replace", payload: { instruction: t } });
  });
  btnSpeak.addEventListener("click", function(){
    var t = getInput(); if (t) send({ type: "operator_speak", payload: { text: t } });
  });
  btnReload.addEventListener("click", function(){
    send({ type: "reload_policy", payload: {} });
  });
  cmdInput.addEventListener("keydown", function(e){
    if (e.key === "Enter" && e.ctrlKey) {
      e.preventDefault();
      var t = getInput(); if (t) send({ type: "operator_speak", payload: { text: t } });
    } else if (e.key === "Enter" && e.shiftKey) {
      e.preventDefault();
      var t = getInput(); if (t) send({ type: "interrupt_and_replace", payload: { instruction: t } });
    } else if (e.key === "Enter" && !e.shiftKey && !e.ctrlKey) {
      e.preventDefault();
      var t = getInput(); if (t) send({ type: "inject_instruction", payload: { instruction: t } });
    }
  });

  // Filter buttons
  filterAll.addEventListener("click", function(){
    filterMode = "all";
    filterAll.className = "filter-btn active";
    filterFlagged.className = "filter-btn";
    renderFullTranscript();
  });
  filterFlagged.addEventListener("click", function(){
    filterMode = "flagged";
    filterFlagged.className = "filter-btn active-flagged";
    filterAll.className = "filter-btn";
    renderFullTranscript();
  });

  // ── Scroll ──
  transcript.addEventListener("scroll", function(){
    var gap = transcript.scrollHeight - transcript.scrollTop - transcript.clientHeight;
    autoScroll = gap < 50;
    if (autoScroll) scrollPill.classList.remove("visible");
  });
  scrollPill.addEventListener("click", function(){
    scrollBottom(); autoScroll = true; scrollPill.classList.remove("visible");
  });
  function scrollBottom() { transcript.scrollTop = transcript.scrollHeight; }

  // ── Util ──
  function esc(s) {
    if (!s) return "";
    return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function fmtTime(ts) {
    if (!ts) return "";
    var d = new Date(ts * 1000);
    return d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }
  function trunc(s, n) { return s && s.length > n ? s.slice(0, n) + "..." : (s || ""); }

  // ── Init ──
  connect();
})();
</script>

</body>
</html>
